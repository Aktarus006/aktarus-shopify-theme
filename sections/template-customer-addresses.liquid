<div class="mx-auto max-w-6xl px-4 py-12" x-data="{ new_address : false }">
  <div class="my-5 flex flex-col items-center justify-between gap-4 md:flex-row">
    <h1 class="text-2xl font-bold text-gray-700">Addresses</h1>
    <button @click="new_address = true" class="bg-gray-700 px-6 py-2 font-medium text-white hover:bg-gray-900">
      Create New Address
    </button>
    <a href="{{ routes.account_url }}" class="font-medium text-blue-600 underline hover:text-blue-800">
      Back to account
    </a>
  </div>
  <div
    class="bg-opacity-50 fixed inset-0 z-50 h-full  w-full overflow-y-auto bg-gray-600"
    x-show="new_address"
    x-transition
  >
    <div @click.away="new_address = false" class="relative top-20 mx-auto max-w-md border bg-white p-4">
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-lg font-medium">New Address</h2>
        <button @click="new_address = false" class="text-gray-500">{% render 'icon-close' %}</button>
      </div>
      {% form 'customer_address', customer.new_address %}
        <div class="mb-4 text-gray-700">
          <label for="address_first_name_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">First Name</label>
          <input
            type="text"
            id="address_first_name_{{ form.id }}"
            name="address[first_name]"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
            value="{{ form.first_name }}"
          >
        </div>
        <div class="mb-4 text-gray-700">
          <label for="address_last_name_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">Last Name</label>
          <input
            type="text"
            id="address_last_name_{{ form.id }}"
            name="address[last_name]"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
            value="{{ form.last_name }}"
          >
        </div>

        <div class="mb-4 text-gray-700">
          <label for="address_company_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">Company</label>
          <input
            type="text"
            id="address_company_{{ form.id }}"
            name="address[company]"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
            value="{{ form.company }}"
          >
        </div>
        <div class="mb-4 text-gray-700">
          <label for="address_address1_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">Address 1</label>
          <input
            type="text"
            id="address_address1_{{ form.id }}"
            name="address[address1]"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
            value="{{ form.address1 }}"
          >
        </div>
        <div class="mb-4 text-gray-700">
          <label for="address_address2_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">Address 2</label>
          <input
            type="text"
            id="address_address2_{{ form.id }}"
            name="address[address2]"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
            value="{{ form.address2 }}"
          >
        </div>
        <div class="mb-4 text-gray-700">
          <label for="address_city_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">City</label>
          <input
            type="text"
            id="address_city_{{ form.id }}"
            name="address[city]"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
            value="{{ form.city }}"
          >
        </div>
        <div class="mb-4 text-gray-700">
          <label for="address_country_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">Country</label>
          <select
            name="address[country]"
            data-country-selector
            data-id="{{ form.id }}"
            id="address_country_{{ form.id }}"
            value="{{ form.country }}"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
          >
            {{ all_country_option_tags }}
          </select>
        </div>
        <div class="mb-4 text-gray-700">
          <label for="address_province_{{ form.id }}" class="mb-2  text-xs font-medium uppercase">Province</label>
          <select
            name="address[province]"
            id="address_province_{{ form.id }}"
            value="{{ form.province }}"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
          ></select>
        </div>
        <div class="mb-4">
          <label for="address_zip_{{ form.id }}" class="mb-2 text-xs font-medium text-gray-700 uppercase">
            Postal/ZIP Code
          </label>
          <input
            type="text"
            name="address[zip]"
            id="address_zip_{{ form.id }}"
            value="{{ form.zip }}"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
          >
        </div>

        <div class="mb-4">
          <label for="address_phone_{{ form.id }}" class="mb-2 text-xs font-medium text-gray-700 uppercase">
            Phone Number
          </label>
          <input
            type="tel"
            name="address[phone]"
            id="address_phone_{{ form.id }}"
            value="{{ form.phone }}"
            class="w-full border border-gray-300 px-4 py-3 focus:outline-none"
          >
        </div>
        <div class="flex flex-row gap-2">
          <button type="submit" class="w-full bg-gray-700 px-4 py-2 font-medium text-white hover:bg-gray-900">
            Create address
          </button>
          <button type="reset" class="w-full border border-gray-700 px-4 py-2 font-medium text-gray-700">Cancel</button>
        </div>
      {% endform %}
    </div>
  </div>
  <div>
    {% paginate customer.addresses by 10 %}
      <div class="md:gri-cols-2 p4 grid grid-cols-1 gap-4 lg:grid-cols-4 lg:gap-12 lg:p-12">
        {% for address in customer.addresses %}
          <div>
            <div class="relative flex flex-col border p-2 text-center">
              {% if address == customer.default_address %}
                <span class="bg-green-700 px-4 py-2 text-xs font-medium text-white">Default</span>
              {% endif %}
              <div class="my-8 h-full">
                {{ address | format_address }}
              </div>
              <div class="flex flex-row gap-2">
                <button class="w-full bg-gray-700 py-2 text-xs font-medium text-white hover:bg-gray-900">Edit</button>
                <button class="w-full border py-2 text-xs font-medium text-gray-700">Delete</button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endpaginate %}
  </div>
</div>

<script>
  class CustomerAddress {
    constructor() {
      this.initCustomerAddress();
      this.customerAddressesSelector();
    }
    initCustomerAddress() {
      const allAddressesSelector = document.querySelectorAll('select[data-country-selector]');
      if (allAddressesSelector.length < 1) return;

      allAddressesSelector.forEach(select => {
        let selectedCountry = this.getSelectedCountry(select);

        if (!selectedCountry) return;
        let provinces = selectedCountry.dataset.provinces;
        let arrayOfProvinces = JSON.parse(provinces);

        let provinceSelector = document.querySelector(`#address_province_${select.dataset.id}`);
        if (arrayOfProvinces.length < 1) {
          provinceSelector.setAttribute('disabled', 'disabled');
        } else {
          provinceSelector.removeAttribute('disabled');
        }

        provinceSelector.innerHTML = '';
        for (let index = 0; index < arrayOfProvinces.length; index++) {
          if (arrayOfProvinces[index][0] === provinceSelector.getAttribute('value')) {
            options += `<option value="${arrayOfProvinces[index][0]}" selected>${arrayOfProvinces[index][1]}</option>`;
          } else {
            options += `<option value="${arrayOfProvinces[index][0]}">${arrayOfProvinces[index][1]}</option>`;
          }
        }
        provinceSelector.innerHTML = options;
      });
    }
    getSelectedCountry(select) {
      let option, selectedOption;
      for (let index = 0; index < select.options.length; index++) {
        option = select.options[index];
        if (option.value === select.getAttribute('value')) {
          selectedOption = option;
          selectedOption.setAttribute('selected', 'selected');
          break;
        }
      }

      return selectedOption;
    }

    customerAddressesSelector() {
      const addressesSelector = document.querySelectorAll('select[data-country-selector]');
      if (addressesSelector.length < 1) return;

      addressesSelector.forEach(select => {
        select.addEventListener('change', function (e) {
          let provinces = this.options[this.selectedIndex].dataset.provinces;
          let arrayOfProvinces = JSON.parse(provinces);

          let provinceSelector = document.querySelector(`#address_province_${select.dataset.id}`);
          if (arrayOfProvinces.length < 1) {
            provinceSelector.setAttribute('disabled', 'disabled');
          } else {
            provinceSelector.removeAttribute('disabled');
          }
          provinceSelector.innerHTML = '';
          for (let index = 0; index < arrayOfProvinces.length; index) {
            let options = '';
            options += `<option value="${arrayOfProvinces[index][0]}">${arrayOfProvinces[index][1]}</option>`;
            provinceSelector.innerHTML += options;
          }
        });
      });
    }
  }
  const customerAddress = new CustomerAddress();
</script>
